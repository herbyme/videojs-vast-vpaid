'use strict';

var Linear = require('./Linear');
var TrackingEvent = require('./TrackingEvent');
var Companion = require('./Companion');
var NonLinear = require('./NonLinear');
var utilities = require('../../utils/utilityFunctions');

function Creative(creativeJTree) {
  if(!(this instanceof Creative)) {
    return new Creative(creativeJTree);
  }

  this.id = creativeJTree.attr('id');
  this.sequence = creativeJTree.attr('sequence');
  this.adId = creativeJTree.attr('adId');
  this.apiFramework = creativeJTree.attr('apiFramework');

  if(creativeJTree.linear) {
    this.linear = new Linear(creativeJTree.linear);
  }

  if (creativeJTree.companionAds) {
    var companions = [];
    var companionAds = creativeJTree.companionAds && creativeJTree.companionAds.companion;
    if (utilities.isDefined(companionAds)) {
      companionAds = utilities.isArray(companionAds) ? companionAds : [companionAds];
      companionAds.forEach(function (companionData) {
        companions.push(new Companion(companionData));
      });
    }
    this.companionAds = companions;
  }

  if (creativeJTree.nonLinearAds && creativeJTree.nonLinearAds.nonLinear) {
    var trackings = [];
    var trackingEvents = creativeJTree.nonLinearAds.trackingEvents
    && creativeJTree.nonLinearAds.trackingEvents.tracking;
    if (utilities.isDefined(trackingEvents)) {
      trackingEvents = utilities.isArray(trackingEvents) ? trackingEvents : [trackingEvents];
      trackingEvents.forEach(function (trackingData) {
        trackings.push(new TrackingEvent(trackingData));
      });
    }

    var nonLinears = [];
    var nonLinearAds = creativeJTree.nonLinearAds && creativeJTree.nonLinearAds.nonLinear;
    if (utilities.isDefined(nonLinearAds)) {
      nonLinearAds = utilities.isArray(nonLinearAds) ? nonLinearAds : [nonLinearAds];
      nonLinearAds.forEach(function (nonLinearAdsChild) {
        var nonLinear = new NonLinear(nonLinearAdsChild);
        if (trackings.length > 0) {
          nonLinear.trackingEvents = trackings;
        }

        nonLinears.push(nonLinear);
      });
    }

    this.nonLinearAds = nonLinears;
  }
}

/**
 * Returns true if the browser supports at the creative.
 */
Creative.prototype.isSupported = function(){
  if(this.linear) {
    return this.linear.isSupported();
  }

  return true;
};

Creative.parseCreatives = function parseCreatives(creativesJTree) {
  var creatives = [];
  var creativesData;
  if (utilities.isDefined(creativesJTree) && utilities.isDefined(creativesJTree.creative)) {
    creativesData = utilities.isArray(creativesJTree.creative) ? creativesJTree.creative : [creativesJTree.creative];
    creativesData.forEach(function (creative) {
      creatives.push(new Creative(creative));
    });
  }
  return creatives;
};

module.exports = Creative;
